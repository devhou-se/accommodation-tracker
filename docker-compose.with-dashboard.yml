version: '3.8'

services:
  # Main accommodation checker service
  accommodation-checker:
    build: .
    container_name: gassho-zukuri-checker-main
    restart: unless-stopped
    volumes:
      - ./config.json:/app/config.json:ro
      - accommodation-data:/app/data
    environment:
      - CONFIG_PATH=/app/config.json
      - LOG_LEVEL=INFO
    networks:
      - gassho-zukuri-network
    depends_on:
      - mock-notification
    healthcheck:
      test: ["CMD", "python", "-c", "import asyncio; import sys; sys.path.insert(0, '/app/src'); from main import AccommodationChecker; from config import load_config; asyncio.run(AccommodationChecker(load_config()).health_check())"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 60s

  # Status dashboard web interface  
  status-dashboard:
    build: .
    container_name: gassho-zukuri-dashboard
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./config.json:/app/config.json:ro
      - accommodation-data:/app/data
    environment:
      - CONFIG_PATH=/app/config.json
      - LOG_LEVEL=INFO
    networks:
      - gassho-zukuri-network
      - traefik
    command: ["python", "/app/src/web/status_server.py"]
    depends_on:
      - accommodation-checker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      
      # Router
      - "traefik.http.routers.jpaccomm.rule=Host(`jpaccomm.baileys.dev`)"
      - "traefik.http.routers.jpaccomm.entrypoints=websecure"
      - "traefik.http.routers.jpaccomm.tls=true"
      - "traefik.http.routers.jpaccomm.tls.certresolver=letsencrypt"
      
      # Service
      - "traefik.http.services.jpaccomm.loadbalancer.server.port=8000"
      
      # Optional: HTTP to HTTPS redirect
      - "traefik.http.routers.jpaccomm-http.rule=Host(`jpaccomm.baileys.dev`)"
      - "traefik.http.routers.jpaccomm-http.entrypoints=web"
      - "traefik.http.routers.jpaccomm-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  # Mock notification service for testing
  mock-notification:
    build: 
      context: ./docker
      dockerfile: Dockerfile.mock
    container_name: gassho-zukuri-mock-notify
    restart: unless-stopped
    ports:
      - "8082:8082"
    networks:
      - gassho-zukuri-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  accommodation-data:
    driver: local

networks:
  gassho-zukuri-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  traefik:
    external: true